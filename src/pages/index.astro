---
import Layout from "../layouts/Layout.astro";
import ProjectListItem from "../components/ProjectListItem.astro";
import TimeSince from "../components/TimeSince.astro";

import { Icon } from "astro-icon/components";

interface ProjectMetadata {
    title: string;
    description: string;
    date: string;
    slug: string;
    hidden: boolean;
    image?: string;
}

interface AstroModule {
    metadata?: ProjectMetadata;
}

function parseDate(dateStr: string): Date {
    // formats like "February 2024", "January - June 2024", "Q1 2023", etc
    const lower = dateStr.toLowerCase();

    if (lower.includes("q1")) return new Date("2023-01-01");
    if (lower.includes("q2")) return new Date("2023-04-01");
    if (lower.includes("q3")) return new Date("2023-07-01");
    if (lower.includes("q4")) return new Date("2023-10-01");

    const months: Record<string, number> = {
        january: 0,
        february: 1,
        march: 2,
        april: 3,
        may: 4,
        june: 5,
        july: 6,
        august: 7,
        september: 8,
        october: 9,
        november: 10,
        december: 11,
    };

    // month and year
    for (const [monthName, monthIndex] of Object.entries(months)) {
        if (lower.includes(monthName)) {
            const yearMatch = dateStr.match(/\b(20\d{2})\b/);
            if (yearMatch) {
                return new Date(parseInt(yearMatch[1]), monthIndex, 1);
            }
        }
    }

    // fallback: try to extract any year
    const yearMatch = dateStr.match(/\b(20\d{2})\b/);
    if (yearMatch) {
        return new Date(parseInt(yearMatch[1]), 0, 1);
    }

    return new Date(0);
}

const isDevMode = import.meta.env.PUBLIC_DEV === "1";

const projects: ProjectMetadata[] = Object.values(
    import.meta.glob<AstroModule>("./projects/*.astro", { eager: true })
)
    .map((module) => module.metadata)
    .filter((metadata): metadata is ProjectMetadata => metadata !== undefined)
    .filter((project) => !project.hidden || isDevMode)
    .sort((a, b) => parseDate(b.date).getTime() - parseDate(a.date).getTime());
---

<style>
    .github-icon-link {
        color: var(--ayu-accent);
        transition: color 0.2s ease;
    }

    .github-icon-link:hover {
        color: var(--ayu-red-500);
    }
</style>

<Layout currentPage={{ title: "home", path: "/" }}>
    <h2 class="text-2xl font-600 text-ayu-green-500">ABOUT</h2>
    <div class="flex flex-col py-2 gap-2 mb-4">
        <span class="flex flex-wrap gap-2">
            <a
                href="https://github.com/hex248"
                target="_blank"
                rel="noopener noreferrer"
                class="github-icon-link flex items-center gap-1"
                title="GitHub Profile"
            >
                <Icon name="mdi:github" class="w-6 h-6" />
                hex248
            </a>
            / <a
                href="mailto:04oliverbryan@gmail.com"
                class="github-icon-link flex items-center gap-1"
                title="Email"
            >
                <Icon name="mdi:email-outline" class="w-6 h-6" />
                04oliverbryan@gmail.com
            </a>
        </span>
        <p>
            AGE: <TimeSince
                date={new Date("11:47:00 2004-11-04")}
                client:react
            />
        </p>
    </div>

    <h2 class="text-2xl font-600 text-ayu-green-500">PROJECTS</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4 py-2">
        {
            projects.map((project) => (
                <ProjectListItem
                    title={project.title}
                    description={project.description}
                    date={project.date}
                    image={project.image}
                    slug={project.slug}
                    isDevMode={isDevMode}
                    isHidden={project.hidden}
                />
            ))
        }
    </div>
</Layout>
